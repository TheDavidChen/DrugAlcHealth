---
title: "Drug and Alcohol Health Analysis"
author: "Deric Liang and David Chen"
date: "04/30/2019"
output: html_document
---

```{r message = FALSE, include = FALSE}
# Clean up R environment
rm(list = ls())

# libraries
library(data.table)
library(tidyverse)
library(lubridate)
library(leaps)
library(rpart)
library(partykit)
library(caret)
library(biglm)
library(randomForest)
#library(sparklyr)

# load data
educ_raw <-
  fread("Data/Education.csv")
healthexp_raw <-
  fread("Data/HealthExpend.csv", header = TRUE)
# pop_raw <-
#   fread("Data/PopulationEstimates.csv")
### population counts included in drug mortality data
poverty_raw <-
  fread("Data/PovertyEstimates.csv")
unemp_raw <-
  fread("Data/Unemployment.csv")
drugmort_raw <-
  fread("Data/Compressed Mortality, 1999-2016.txt")

unint_death <- 
  fread('Data/X4045_Mortality.txt')
int_death <-
  fread('Data/X6065_Mortality.txt')

# define functions

identify_region <- function(state) {
  # Purpose: This functions identifies the region of a state
  # Inputs:
  ### state: United States state in a character format
  # Output: Which region of the United States the state applies to. If none, NA.
  
  Northeast <- c('Maine', 'New Hampshire', 'Vermont', 'Massachusetts', 
               'Rhode Island', 'Connecticut', 'New York', 'New Jersey',
               'Pennsylvania')

  Midwest <- c('Ohio', 'Michigan', 'Indiana', 'Wisconsin', 'Illinois', 
               'Minnesota', 'Iowa', 'Missouri', 'North Dakota', 
               'South Dakota', 'Nebraska', 'Kansas')
  
  South <- c('Delaware', 'Maryland', 'Virginia', 'West Virginia', 'Kentucky', 
             'North Carolina', 'South Carolina', 'Tennessee', 'Georgia', 
             'Florida', 'Alabama', 'Mississippi', 'Arkansas', 'Louisiana', 
             'Texas', 'Oklahoma')
  
  West <- c('Montana', 'Idaho', 'Wyoming', 'Colorado', 'New Mexico', 
            'Arizona', 'Utah', 'Nevada', 'California', 'Oregon', 
            'Washington', 'Alaska', 'Hawaii')
  
  if (state %in% Northeast) {
    return('Northeast')
  }
  else if (state %in% Midwest) {
    return('Midwest')
  }
  else if (state %in% South) {
    return('South') 
  }
  else if (state %in% West) {
    return('West')
  }
  else {
    return(NA)
  }
}

```

## Data Wrangling
```{r}
# Drug Mortality Data
### Remove unnecessary columns and `Total` row
drugmort <-
  drugmort_raw %>%
  na.omit() %>%
  select(-Notes, -`State Code`) %>%
  mutate(Deaths = as.numeric(Deaths)) %>%
  rename(DrugDeaths = Deaths,
         DrugMortalityRate = `Crude Rate`)

# Education Level Data
### Clean headers, select for state data, select relevant columns
educ <-
  educ_raw %>%
  distinct(State, .keep_all = TRUE) %>%
  filter(`FIPS Code` != is.na(`FIPS Code`),
         State != "PR") %>%
  select(`Area name`, `Percent of adults with a bachelor's degree or higher, 2013-17`,
         `Percent of adults completing some college or associate's degree, 2013-17`,
         `Percent of adults with a high school diploma only, 2013-17`,
         `Percent of adults with less than a high school diploma, 2013-17`) %>%
  rename(State = `Area name`,
         PercentBachelor = `Percent of adults with a bachelor's degree or higher, 2013-17`,
         PercentAssoc = `Percent of adults completing some college or associate's degree, 2013-17`,
         PercentHS = `Percent of adults with a high school diploma only, 2013-17`,
         PercentLessHS = `Percent of adults with less than a high school diploma, 2013-17`)

# Health Expenditure Data
### Remove non-state rows, extraneous column
healthexp <-
  healthexp_raw[1:51] %>%
  rename(HealthExpenditure = `2016`, State = STATE) %>%
  mutate(HealthExpenditure = parse_number(HealthExpenditure)) %>%
  select(State, HealthExpenditure)

# Poverty Data
### Clean headers, select for state data, select relevant columns
poverty_raw$State[poverty_raw$State == "Wi"] <- "WI"
poverty <-
  poverty_raw %>%
  distinct(State, .keep_all = TRUE) %>%
  filter(FIPStxt != is.na(FIPStxt)) %>%
  select(Area_Name, POVALL_2017, PCTPOVALL_2017, POV017_2017, PCTPOV017_2017) %>%
  rename(State = Area_Name,
         PovertyCountAll = POVALL_2017,
         PovertyPctAll = PCTPOVALL_2017,
         PovertyCount0_17 = POV017_2017,
         PovertyPctAll0_17 = PCTPOV017_2017) %>%
  mutate(PovertyCountAll = parse_number(PovertyCountAll),
         PovertyCount0_17 = parse_number(PovertyCount0_17))

# Unemployment Data
### Clean headers, select for state data, select relevant columns
unemp_raw$State[unemp_raw$State == "Co"] <- "CO"
unemployment <-
  unemp_raw %>%
  distinct(State, .keep_all = TRUE) %>%
  filter(FIPStxt != is.na(FIPStxt),
         State != "PR") %>%
  select(Area_name, Civilian_labor_force_2016, Unemployed_2016, Unemployment_rate_2016) %>%
  rename(State = Area_name,
         LaborForce = Civilian_labor_force_2016,
         Unemployed = Unemployed_2016,
         UnemploymentRate = Unemployment_rate_2016) %>%
  mutate(LaborForce = parse_number(LaborForce),
         Unemployed = parse_number(Unemployed))

```

```{r}

intdeath <-
  int_death %>%
  filter(State != "District of Columbia") %>%
  select(-Notes, -`State Code`) %>%
  mutate(Deaths = as.numeric(Deaths)) %>%
  rename(int_DrugDeaths = Deaths,
         int_DrugMortalityRate = `Crude Rate`) %>%
  mutate(int_DrugMortalityRate = parse_number(int_DrugMortalityRate))

unintdeath <-
  unint_death %>%
  filter(State != "District of Columbia") %>%
  select(-Notes, -`State Code`, -`Population`) %>%
  mutate(Deaths = as.numeric(Deaths)) %>%
  rename(unint_DrugDeaths = Deaths,
         unint_DrugMortalityRate = `Crude Rate`) 


combined_deaths <- 
  left_join(intdeath, unintdeath, by = 'State')


HealthData <-
  left_join(combined_deaths, drugmort, by = c("State", 'Population')) %>%
  left_join(healthexp, by = "State") %>%
  left_join(educ, by = 'State') %>%
  left_join(poverty, by = 'State') %>%
  left_join(unemployment, by = 'State') %>%
  filter(State != "District of Columbia")
```



```{r}
#EDA 

ggplot(combined_deaths, aes(x = unint_DrugDeaths, y = int_DrugDeaths)) +
  geom_point()
ggplot(combined_deaths, aes(x = unint_DrugMortalityRate, y = int_DrugMortalityRate)) +
  geom_point()
```

### Data Wrangling - Regions according to the US Census Bureau:  

Sourced from : https://www.businessinsider.com/united-states-regions-new-england-midwest-south-2018-4    

1. "The Northeast includes Maine, New Hampshire, Vermont, Massachusetts, Rhode Island, Connecticut, New York, New Jersey, and Pennsylvania."  

2. "[The Midwest] consists of Ohio, Michigan, Indiana, Wisconsin, Illinois, Minnesota, Iowa, Missouri, North Dakota, South Dakota, Nebraska, and Kansas."  

3. "...the South consists of Delaware, Maryland, Virginia, West Virginia, Kentucky, North Carolina, South Carolina, Tennessee, Georgia, Florida, Alabama, Mississippi, Arkansas, Louisiana, Texas, and Oklahoma."   

4. "The West consists of Montana, Idaho, Wyoming, Colorado, New Mexico, Arizona, Utah, Nevada, California, Oregon, Washington, Alaska, and Hawaii."  

```{r}
# Attaching region to dataset

HealthData_region <- 
  HealthData %>%
  
  # This line identifies the region and creates the variable
  mutate(region = sapply(HealthData$State, FUN = identify_region)) %>%
  
  # Create a copy of region to unnest and spread
  mutate(region_copy = region) %>%
  
  # The following code creates dummy variables for region
  unnest(region_copy) %>% 
  mutate(new = 1) %>% 
  spread(region_copy, new, fill = 0) 

```

```{r}

ggplot(HealthData_region, aes(x = reorder(State, -DrugMortalityRate), 

                          y = DrugMortalityRate, fill = region)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = 'Drug Mortality Rate per 10000', x = 'State', title = 'Drug Mortality Rate per 10000')
```
```{r}
ggplot(HealthData_region, aes(x = reorder(State, -unint_DrugMortalityRate), 
                          y = unint_DrugMortalityRate, fill = region)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = 'Drug Mortality Rate per 10000', x = 'State', 
       title = 'Unintentional Drug Mortality Rate per 10000')
```



## Regression Models/Supervised Learning

```{r}
form <- 
  DrugMortalityRate ~ HealthExpenditure + PercentBachelor + PovertyPctAll + UnemploymentRate
```

### Null Model

```{r}
null_mod <-
  lm(DrugMortalityRate ~ 1, data = HealthData_region)
summary(null_mod)
nullrsq <-
  1 - sum((null_mod$residuals)^2) / sum((HealthData_region$DrugMortalityRate - mean(HealthData_region$DrugMortalityRate))^2)
nullrsq
```

The mean drug mortality rate for the training data is 20.124, with an R-squared of $1.11 * 10^{-16}$.

### Regression

```{r}
fullhealth_lm <-
  lm(form, data = HealthData_region)
summary(fullhealth_lm)
plot(fullhealth_lm)
```

The fitted model is not good; none of the regressors are significant.

```{r}
subsets <-
  regsubsets(form, data = HealthData_region, nbest = 5)
plot(subsets)
```

The model with just the `UnemploymentRate` regressor is the best.

```{r}
HealthData_region %>%
  ggplot(aes(x = UnemploymentRate, y = DrugMortalityRate)) +
  geom_point(aes(color = region)) +
  stat_smooth(color = "grey50", method = lm, se = 0) +
  xlab("Unemployment Rate") +
  ylab("Drug Mortality Rate") +
  labs(title = "Drug Mortality Rate vs. Unemployment Rate")
```

A visual of the fit of Drug Mortality Rate vs. Unemployment Rate.


```{r}
red_lm <-
  lm(DrugMortalityRate ~ UnemploymentRate, data = HealthData_region)
summary(red_lm)
plot(red_lm)
```

Our regression modeling shows us that only the Unemployment Rate has a significant effect on the Drug Mortality Rate. Checking diagnostics plots, we are fine to assume linearity, independence, normality, and equivariance.

### Supervised Learning

We want to explore other modeling methods which could help us predict Drug Mortality Rate, beyond classical regression models.

*Regression Tree*

```{r}
regtree <-
  rpart(form, data = HealthData_region)
plot(as.party(regtree))
```

The regression tree shows that the education level (the percent of people who have a Bachelor's degree) is also significant in predicting Drug Mortality Rate, in addition to Unemployment Rate. An unemployment rate greater than or equal to 4.45% shows higher drug mortality, and within that group, states with less than 27.65% of people having a Bachelors shows higher drug mortality than states with more than 27.65% of people having a Bachelors. For states with an unemployment rate of less than 4.45%, states with more than 32.4% of people having a Bachelors has a higher drug mortality than states with less than 32.4% of people having a Bachelors. This generally shows that unemployment rate is more important than the education level in predicting drug mortality rate.

```{r}
# define training control
train_control <- 
  trainControl(method = "cv", number = 10)
# train the model
regtreecv <- 
  form %>%
  train(data = na.omit(HealthData_region), trControl = train_control, method = "rpart")
# summarize results
regtreecv
```

The Regression Tree gives an R-squared of 0.3113, much better than the previous models.

*Random Forest*

```{r}
# train the model
forestcv <- 
  form %>%
  train(data = na.omit(HealthData_region), trControl = train_control, method = "rf")
# summarize results
forestcv
```

```{r}
trainforest <-
  randomForest(form, data = HealthData_region, ntree = 200, 
               mtry = 2, na.action = na.omit)
importance(trainforest) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(IncNodePurity))
```

The Random Forest (with mtry = 2) gives an R-squared of 0.1924, worse than the regression tree but better than the other models. This model states that the percent of people with a Bachelors is the most important predictor of drug mortality rate, followed by unemployment rate, then percent of people in poverty, then health expenditure. This is consistent with what we have found in previous models, and is important to see as the biggest question in exploring this data was to see whether health expenditure affected drug mortality rates, and here we see it is not as important as other factors.

### Summary

Generally, we learned that the unemployment rate and education level (the percent of people with a Bachelors) are the biggest predictors in drug mortality rate, consistent across several models. The percent of people in poverty and health expenditure are not as significant in predicting drug mortality rate.

## Unsupervised Learning


```{r}
HealthData_pca <- 
  HealthData_region %>%
  select(-c('State', 'region', 'DrugDeaths', 'DrugMortalityRate', 'Midwest', 'Northeast',
            'South', 'West', 'PercentAssoc', 'Unemployed', 'PovertyCountAll')) %>%
  na.omit() %>%
  prcomp(scale = TRUE)  

str(HealthData_pca)
```

```{r}
(-1) * HealthData_pca$rotation[, 1:2] %>% round(2)
```

```{r}

names <- na.omit(HealthData_region)
Region <- names$region

HealthData_pca$x %>%
  as.data.frame() %>%  
  rownames_to_column() %>%
  ggplot(aes(x = PC1, y = PC2)) + 
  geom_text(aes(label = names$State), size = 3) + 
  xlab("Best Vector from PCA (approx. Intentional Self-Poisoning Rate") + 
  ylab("2nd Best Vector from PCA (approx. Education)") + 
  ggtitle("Two-dimensional representation of Drug Mortality by State")

HealthData_pca$x %>%
  as.data.frame() %>%  
  ggplot(aes(x = PC1, y = PC2)) + 
  geom_point(aes(color = Region), size = 3) + 
  xlab("Best Vector from PCA (approx. Intentional Self-Poisoning Rate") + 
  ylab("2nd Best Vector from PCA (approx. Education)") + 
  ggtitle("Two-dimensional representation of Drug Mortality by Region")
```

```{r}

HealthData_pve <- 
  data.frame(sd = HealthData_pca$sdev) %>%
  rownames_to_column() %>%
  mutate(rowname = parse_number(rowname), 
         totalVar = sum(HealthData_pca$sdev^2), 
         pve = 100 * sd^2 / totalVar, 
         cusum = cumsum(pve))

# scree plot
HealthData_pve %>%
  ggplot(aes(x = rowname, y = pve)) + 
  geom_line(type = 3) + 
  xlab("Principal Component") + 
  ylab("Proportion of Variance Explained") + 
  ggtitle("Scree Plot of Principal Components for Health Data") 

  
# cumulative PVE plot
HealthData_pve %>%
  ggplot(aes(x = rowname, y = cusum)) + 
  geom_line(type = 3) + 
  xlab("Principal Component") + 
  ylab("Proportion of Variance Explained") + 
  ggtitle("Cumulative Proportion of Variance Explained for Health Data") 

```

```{r}

HD_std <- 
  HealthData_region %>%
  select(c(int_DrugMortalityRate, unint_DrugMortalityRate, HealthExpenditure)) %>%
  na.omit() %>%
  scale() %>%
  as.data.frame()

colnames(HealthData_region)

```

```{r}

HD_dist <- dist(HD_std)
# # plot dedrogram (average linkage)
# NCI_dist %>%
#   hclust(method = "average") %>%
#   plot(cex = 0.9, labels = cancerLabels, main = "NCI60 Dendogram with Average Linkage")
# construct dendogram (complete linkage)
HD_dendo <-
  HD_dist %>%
  hclust(method = "complete")
# print dendogram info (distance & method)
print(HD_dendo)


HD_dendo %>%
  plot(cex = 0.9, labels = HealthData_region$State, lwd = 2,
       main = "Health Data Dendogram with Complete Linkage")

```

## Big Data Tools









